component extends="preside.system.base.AdminHandler" {

	property name="dao"        inject="presidecms:object:${objectId}";
	property name="messageBox" inject="coldbox:plugin:messageBox";

	function prehandler( event, rc, prc ) {
		super.preHandler( argumentCollection = arguments );

		_checkPermissions( event=event, key="read" );

		event.addAdminBreadCrumb(
			  title = translateResource( "${translationFile}:breadcrumb" )
			, link  = event.buildAdminLink( linkTo="${handlerRoot}" )
		);

		prc.pageIcon = "${pageIcon}";
	}

	function index( event, rc, prc ) {
		prc.pageTitle    = translateResource( "${translationFile}:page.title" );
		prc.pageSubtitle = translateResource( "${translationFile}:page.subtitle" );

		prc.canAdd    = hasCmsPermission( "${permissionKey}.add"    );
		prc.canDelete = hasCmsPermission( "${permissionKey}.delete" );
	}

	function add( event, rc, prc ) {
		_checkPermissions( event=event, key="add" );

		prc.pageTitle    = translateResource( "${translationFile}:add.page.title" );
		prc.pageSubtitle = translateResource( "${translationFile}:add.page.subtitle" );

		prc.canPublish   = hasCmsPermission( "${permissionKey}.saveDraft" );
		prc.canSaveDraft = hasCmsPermission( "${permissionKey}.publish"   );

		if ( !prc.canPublish && !prc.canSaveDraft ) {
			event.adminAccessDenied();
		}

		event.addAdminBreadCrumb(
			  title = translateResource( "${translationFile}:add.page.breadcrumb" )
			, link  = event.buildAdminLink( linkTo="${handlerRoot}.add" )
		);
	}
	function addAction( event, rc, prc ) {
		_checkPermissions( event=event, key="add" );

		var saveAction = ( rc._saveAction ?: "savedraft" ) == "publish" ? "publish" : "savedraft";
		_checkPermissions( event=event, key=saveAction );

		prc.canPublish   = hasCmsPermission( "${permissionKey}.saveDraft" );
		prc.canSaveDraft = hasCmsPermission( "${permissionKey}.publish"   );

		runEvent(
			  event          = "admin.DataManager._addRecordAction"
			, prePostExempt  = true
			, private        = true
			, eventArguments = {
				  object            = "${objectId}"
				, errorAction       = "${handlerRoot}.add"
				, addAnotherAction  = "${handlerRoot}.add"
				, successAction     = "${handlerRoot}"
				, redirectOnSuccess = true
				, audit             = true
				, auditType         = "${auditCategory}"
				, auditAction       = saveAction == "publish" ? "add_record" : "add_draft_record"
				, draftsEnabled     = true
				, canPublish        = prc.canPublish
				, canSaveDraft      = prc.canSaveDraft
			}
		);
	}

	function edit( event, rc, prc ) {
		_checkPermissions( event=event, key="edit" );
		prc.canSaveDraft = hasCmsPermission( "${permissionKey}.saveDraft" );
		prc.canPublish   = hasCmsPermission( "${permissionKey}.publish"   );
		if ( !prc.canSaveDraft && !prc.canPublish ) {
			event.adminAccessDenied()
		}

		var id      = rc.id ?: "";
		var version = Val( rc.version ?: "" );

		prc.record = dao.selectData(
			  filter             = { id=id }
			, fromVersionTable   = true
			, allowDraftVersions = true
			, specificVersion    = version
		);

		if ( !prc.record.recordCount ) {
			messageBox.error( translateResource( uri="${translationFile}:record.not.found.error" ) );
			setNextEvent( url=event.buildAdminLink( linkTo="${handlerRoot}" ) );
		}
		prc.record = queryRowToStruct( prc.record );

		prc.pageTitle    = translateResource( uri="${translationFile}:edit.page.title", data=[ prc.record.${labelfield} ] );
		prc.pageSubtitle = translateResource( uri="${translationFile}:edit.page.subtitle", data=[ prc.record.${labelfield} ] );

		event.addAdminBreadCrumb(
			  title = translateResource( uri="${translationFile}:edit.page.breadcrumb", data=[ prc.record.${labelfield} ] )
			, link  = event.buildAdminLink( linkTo="${handlerRoot}.edit", queryString="id=#id#" )
		);
	}
	function editAction( event, rc, prc ) {
		_checkPermissions( event=event, key="edit" );

		var id = rc.id ?: "";
		var saveAction = ( rc._saveAction ?: "savedraft" ) == "publish" ? "publish" : "savedraft";
		_checkPermissions( event=event, key=saveAction );

		prc.record = dao.selectData( filter={ id=id } );

		if ( !prc.record.recordCount ) {
			messageBox.error( translateResource( uri="${translationFile}:record.not.found.error" ) );
			setNextEvent( url=event.buildAdminLink( linkTo="${handlerRoot}" ) );
		}

		runEvent(
			  event          = "admin.DataManager._editRecordAction"
			, private        = true
			, prePostExempt  = true
			, eventArguments = {
				  object            = "${objectId}"
				, errorAction       = "${handlerRoot}.edit"
				, successUrl        = event.buildAdminLink( linkto="${handlerRoot}" )
				, redirectOnSuccess = true
				, audit             = true
				, auditType         = "${auditCategory}"
				, auditAction       = ( saveAction == "publish" ? "publish_record" : "save_draft" )
				, draftsEnabled     = true
				, canPublish        = hasCmsPermission( "${permissionKey}.saveDraft" )
				, canSaveDraft      = hasCmsPermission( "${permissionKey}.publish"   )
			}
		);
	}

	function deleteAction( event, rc, prc ) {
		_checkPermissions( event=event, key="delete" );

		runEvent(
			  event          = "admin.DataManager._deleteRecordAction"
			, private        = true
			, prePostExempt  = true
			, eventArguments = {
				  object       = "${objectId}"
				, postAction   = "${handlerRoot}"
				, audit        = true
				, auditType    = "${auditCategory}"
				, auditAction  = "delete_record"
			}
		);
	}

	public void function versionHistory( event, rc, prc ) {
		var id = rc.id ?: "";

		prc.record = dao.selectData( id=id, selectFields=[ "${labelfield}" ] );
		if ( !prc.record.recordCount ) {
			messageBox.error( translateResource( uri="${translationFile}:record.not.found.error" ) );
			setNextEvent( url=event.buildAdminLink( linkTo="${handlerRoot}" ) );
		}
		prc.pageTitle    = translateResource( uri="${translationFile}:versionHistory.page.title"   , data=[ prc.record.${labelfield} ] );
		prc.pageSubTitle = translateResource( uri="${translationFile}:versionHistory.page.subTitle", data=[ prc.record.${labelfield} ] );

		event.addAdminBreadCrumb(
			  title = translateResource( uri="${translationFile}:versionHistory.breadcrumb"  , data=[ prc.record.${labelfield} ] )
			, link  = event.buildAdminLink( linkTo="${handlerRoot}.versionHistory", queryString="id=" & id )
		);
	}

	public void function getRecordsForAjaxDataTables( event, rc, prc ) {
		_checkPermissions( event=event, key="read" );

		runEvent(
			  event          = "admin.DataManager._getObjectRecordsForAjaxDataTables"
			, prePostExempt  = true
			, private        = true
			, eventArguments = {
				  object        = "${objectId}"
				, gridFields    = "${labelfield}"
				, actionsView   = "admin.${handlerFolder}._gridActions"
				, draftsEnabled = true
			}
		);
	}

	private string function _gridActions( event, rc, prc, args={} ) {
		args.id                = args.id ?: "";
		args.deleteRecordLink  = event.buildAdminLink( linkTo="${handlerRoot}.deleteAction"  , queryString="id=" & args.id );
		args.editRecordLink    = event.buildAdminLink( linkTo="${handlerRoot}.edit"          , queryString="id=" & args.id );
		args.viewHistoryLink   = event.buildAdminLink( linkTo="${handlerRoot}.versionHistory", queryString="id=" & args.id );
		args.deleteRecordTitle = translateResource( "${translationFile}:delete.record.link.title" );
		args.objectName        = "${objectId}";
		args.canEdit           = hasCmsPermission( "${permissionKey}.edit"   );
		args.canDelete         = hasCmsPermission( "${permissionKey}.delete" );
		args.canViewHistory    = hasCmsPermission( "${permissionKey}.view"   );

		return renderView( view="/admin/${handlerFolder}/_gridActions", args=args );
	}

	public void function getHistoryForAjaxDatatables( event, rc, prc ) {
		var id = rc.id ?: "";

		prc.record = dao.selectData( id=id, selectFields=[ "${labelfield} as label" ] );
		if ( !prc.record.recordCount ) {
			event.notFound();
		}

		runEvent(
			  event          = "admin.DataManager._getRecordHistoryForAjaxDataTables"
			, prePostExempt  = true
			, private        = true
			, eventArguments = {
				  object     = "${objectId}"
				, recordId   = id
				, actionsView = "admin/${handlerFolder}/_historyActions"
			}
		);
	}

// private utility
	private void function _checkPermissions( required any event, required string key ) {
		if ( !hasCmsPermission( "${permissionKey}." & arguments.key ) ) {
			event.adminAccessDenied();
		}
	}

}